# nginx proxy application vhost
#
# Generated by Chef for <%= node[:fqdn] %>
# Local modifications will be overwritten.
#
# Author:: Doug MacEachern <dougm@vmware.com>
# Author:: Fletcher Nichol <fnichol@nichol.ca>
# Author:: Noah Kantrowitz <noah@coderanger.net>
#
# Copyright 2010, VMware, Inc.
# Copyright 2013-2014, Noah Kantrowitz
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

<% if @new_resource.ssl_enabled && @new_resource.ssl_redirect_http -%>
server {
<% @new_resource.listen_ports.each do |port| -%>
  listen            <%= port %>;
<% end -%>
  server_name <%= Array(@new_resource.hostname).join(' ') %>;
  rewrite     ^(.*) https://$host$1 permanent;
}
<% end -%>

server {
<% (@new_resource.ssl_enabled ? @new_resource.ssl_listen_ports : @new_resource.listen_ports).each do |port| -%>
  listen            <%= port %>;
<% end -%>
  server_name       <%= Array(@new_resource.hostname).join(' ') %>;

  client_max_body_size 1024m;

<% if @new_resource.ssl_enabled -%>
  ssl on;
  ssl_certificate     <%= @new_resource.ssl_cert_path %>;
  ssl_certificate_key <%= @new_resource.ssl_key_path %>;

  # Via https://hynek.me/articles/hardening-your-web-servers-ssl-ciphers/
  ssl_prefer_server_ciphers On;
  ssl_protocols SSLv3 TLSv1 TLSv1.1 TLSv1.2;
  ssl_ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS;

  ssl_session_cache   shared:SSL:10m;
  ssl_session_timeout 10m;
<% end -%>

  location / {
    proxy_pass http://127.0.0.1:<%= @new_resource.port %>;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Host $http_host;
    <%- if @new_resource.ssl_enabled -%>
    proxy_redirect http:// https://;
    <%- end -%>
  }

  <%= @new_resource.extra_content %>
}
