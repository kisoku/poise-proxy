# apache proxy application vhost
#
# Generated by Chef for <%= node[:fqdn] %>
# Local modifications will be overwritten.
#
# Author:: Doug MacEachern <dougm@vmware.com>
# Author:: Fletcher Nichol <fnichol@nichol.ca>
# Author:: Noah Kantrowitz <noah@coderanger.net>
#
# Copyright 2010, VMware, Inc.
# Copyright 2013-2014, Noah Kantrowitz
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

<% if @new_resource.ssl_enabled && @new_resource.ssl_redirect_http -%>
<% @new_resource.listen_ports.select{|port| port.to_i != 80}.each do |port| -%>
Listen <%= port %> http
NameVirtualHost *:<%= port %>
<% end -%>
<VirtualHost <%= @new_resource.listen_ports.map{|port| "*:#{port}"}.join(' ') %>>
  ServerName <%= Array(@new_resource.hostname).first %>
  <%- if Array(@new_resource.hostname).length > 1 -%>
  ServerAlias <%= Array(@new_resource.hostname).drop(1).join(' ') %>
  <%- end -%>
  RewriteEngine On
  RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>
<% end -%>

<% main_ports = @new_resource.ssl_enabled ? @new_resource.ssl_listen_ports : @new_resource.listen_ports -%>
<% main_ports.select{|port| port.to_i != (@new_resource.ssl_enabled ? 443 : 80)}.each do |port| -%>
Listen <%= port %><%= @new_resource.ssl_enabled ? 'https' : 'http' %>
NameVirtualHost *:<%= port %>
<% end -%>
<VirtualHost <%= main_ports.map{|port| "*:#{port}"}.join(' ') %>>
  ServerName <%= Array(@new_resource.hostname).first %>
  <%- if Array(@new_resource.hostname).length > 1 -%>
  ServerAlias <%= Array(@new_resource.hostname).drop(1).join(' ') %>
  <%- end -%>

  <%- if @new_resource.ssl_enabled -%>
  SSLEngine on
  SSLCertificateFile <%= @new_resource.ssl_cert_path %>
  SSLCertificateKeyFile <%= @new_resource.ssl_key_path %>

  # Via https://hynek.me/articles/hardening-your-web-servers-ssl-ciphers/
  SSLProtocol ALL -SSLv2
  SSLHonorCipherOrder On
  SSLCipherSuite ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS
  <%- end -%>

  ProxyRequests off
  # Local reverse proxy authorization override
  # Most unix distribution deny proxy by default
  # (ie /etc/apache2/mods-enabled/proxy.conf in Ubuntu)
  <Proxy http://localhost:<%= @new_resource.port %>/*>
    Order deny,allow
    Allow from all
  </Proxy>

  ProxyPreserveHost on
  ProxyPass / http://localhost:<%= @new_resource.port %>/
  ProxyPassReverse / http://localhost:<%= @new_resource.port %>/
  <%- Array(@new_resource.hostname).each do |host| -%>
  ProxyPassReverse / http://<%= host %>/
  <%- end -%>
</VirtualHost>
